{% extends 'core/admin_base.html' %}
{% load static %}

{% block title %}Library Admin Dashboard - Library Management System{% endblock %}
{% block breadcrumb_title %}Dashboard{% endblock %}
{% block page_title %}Library Admin Dashboard{% endblock %}

{% block page_actions %}
<a href="{% url 'books:create_book' %}" class="admin-pro-btn admin-pro-btn-primary">
    <i class="fas fa-plus"></i> Add Book
</a>
<a href="{% url 'libraries:manage_library_staff' slug=library.slug %}" class="admin-pro-btn admin-pro-btn-outline">
    <i class="fas fa-user-plus"></i> Add Staff
</a>
{% endblock %}

{% block content %}
<div class="admin-pro-welcome-message mb-4">
    <div class="admin-pro-welcome-icon">
        <i class="fas fa-book-reader"></i>
    </div>
    <div class="admin-pro-welcome-content">
        <h2>Welcome back, {{ user.get_full_name|default:"Library Admin" }}!</h2>
        <p>Here's what's happening at {{ library.name }} today.</p>
    </div>
</div>

    <!-- Library Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-pro-card">
                <div class="admin-pro-card-header d-flex justify-content-between align-items-center">
                    <h3 class="admin-pro-card-title">
                        <i class="fas fa-building me-2 text-primary"></i>Library Information
                    </h3>
                    <div class="admin-pro-card-actions">
                        <a href="{% url 'libraries:manage_library' slug=library.slug %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-primary">
                            <i class="fas fa-edit"></i> Edit Library
                        </a>
                        <a href="{% url 'libraries:library_detail' slug=library.slug %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-outline">
                            <i class="fas fa-eye"></i> View Public Page
                        </a>
                    </div>
                </div>
                <div class="admin-pro-card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="admin-pro-library-image">
                                {% if library.image %}
                                    <img src="{{ library.image.url }}" alt="{{ library.name }}">
                                {% else %}
                                    <div class="admin-pro-library-placeholder">
                                        <i class="fas fa-building"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="admin-pro-library-details">
                                <h3 class="admin-pro-library-name">{{ library.name }}</h3>
                                <div class="admin-pro-library-info">
                                    <div class="admin-pro-library-info-item">
                                        <div class="admin-pro-library-info-icon">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </div>
                                        <div class="admin-pro-library-info-content">
                                            {{ library.address }}, {{ library.city }}, {{ library.state }}, {{ library.postal_code }}, {{ library.country }}
                                        </div>
                                    </div>
                                    <div class="admin-pro-library-info-item">
                                        <div class="admin-pro-library-info-icon">
                                            <i class="fas fa-phone"></i>
                                        </div>
                                        <div class="admin-pro-library-info-content">
                                            {{ library.phone }}
                                        </div>
                                    </div>
                                    <div class="admin-pro-library-info-item">
                                        <div class="admin-pro-library-info-icon">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <div class="admin-pro-library-info-content">
                                            {{ library.email }}
                                        </div>
                                    </div>
                                    {% if library.website %}
                                    <div class="admin-pro-library-info-item">
                                        <div class="admin-pro-library-info-icon">
                                            <i class="fas fa-globe"></i>
                                        </div>
                                        <div class="admin-pro-library-info-content">
                                            <a href="{{ library.website }}" target="_blank">{{ library.website }}</a>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if library.opening_hours %}
                                    <div class="admin-pro-library-info-item">
                                        <div class="admin-pro-library-info-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="admin-pro-library-info-content">
                                            {{ library.opening_hours }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-pro-card">
                <div class="admin-pro-stats-card success">
                    <div class="admin-pro-stats-icon" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="admin-pro-stats-content">
                        <h3 class="admin-pro-stats-value">{{ book_copies.count }}</h3>
                        <p class="admin-pro-stats-label">Total Books</p>
                        <div class="admin-pro-stats-trend up">
                            <i class="fas fa-arrow-up"></i> 3% from last month
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-pro-card">
                <div class="admin-pro-stats-card info">
                    <div class="admin-pro-stats-icon" style="background: linear-gradient(135deg, #3498db 0%, #5dade2 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="admin-pro-stats-content">
                        <h3 class="admin-pro-stats-value">{{ staff_members.count }}</h3>
                        <p class="admin-pro-stats-label">Staff Members</p>
                        <div class="admin-pro-stats-trend up">
                            <i class="fas fa-arrow-up"></i> 2% from last month
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-pro-card">
                <div class="admin-pro-stats-card primary">
                    <div class="admin-pro-stats-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="admin-pro-stats-content">
                        <h3 class="admin-pro-stats-value">{{ library.memberships.filter.is_active.count }}</h3>
                        <p class="admin-pro-stats-label">Active Members</p>
                        <div class="admin-pro-stats-trend up">
                            <i class="fas fa-arrow-up"></i> 5% from last month
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-pro-card">
                <div class="admin-pro-stats-card warning">
                    <div class="admin-pro-stats-icon" style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="admin-pro-stats-content">
                        <h3 class="admin-pro-stats-value">{{ transactions.count }}</h3>
                        <p class="admin-pro-stats-label">Transactions</p>
                        <div class="admin-pro-stats-trend up">
                            <i class="fas fa-arrow-up"></i> 8% from last month
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-pro-card">
                <div class="admin-pro-card-header">
                    <h3 class="admin-pro-card-title">
                        <i class="fas fa-bolt me-2 text-warning"></i>Quick Actions
                    </h3>
                </div>
                <div class="admin-pro-card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'libraries:manage_library_staff' slug=library.slug %}" class="admin-pro-action-card">
                                <div class="admin-pro-action-icon bg-info">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="admin-pro-action-content">
                                    <h4>Manage Staff</h4>
                                    <p>Add, edit or remove staff</p>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'books:manage_books' %}" class="admin-pro-action-card">
                                <div class="admin-pro-action-icon bg-success">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="admin-pro-action-content">
                                    <h4>Manage Books</h4>
                                    <p>Add, edit or remove books</p>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'libraries:manage_library_members' slug=library.slug %}" class="admin-pro-action-card">
                                <div class="admin-pro-action-icon bg-primary">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                                <div class="admin-pro-action-content">
                                    <h4>Manage Members</h4>
                                    <p>Add, edit or remove members</p>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'transactions:transaction_reports' %}" class="admin-pro-action-card">
                                <div class="admin-pro-action-icon bg-warning">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="admin-pro-action-content">
                                    <h4>View Reports</h4>
                                    <p>View transaction reports</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-pro-card">
                <div class="admin-pro-card-header d-flex justify-content-between align-items-center">
                    <h3 class="admin-pro-card-title">
                        <i class="fas fa-exchange-alt me-2 text-warning"></i>Recent Transactions
                    </h3>
                    <div class="admin-pro-card-actions">
                        <a href="{% url 'transactions:transaction_list' %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-outline">
                            <i class="fas fa-list"></i> View All
                        </a>
                    </div>
                </div>
                <div class="admin-pro-card-body">
                    <div class="admin-pro-table-container">
                        <table class="admin-pro-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Book</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions|slice:":5" %}
                                    <tr>
                                        <td>{{ transaction.transaction_date|date:"M d, Y" }}</td>
                                        <td>
                                            <div class="admin-pro-user-small">
                                                <div class="admin-pro-user-small-img">
                                                    {% if transaction.user.profile_picture %}
                                                        <img src="{{ transaction.user.profile_picture.url }}" alt="{{ transaction.user.get_full_name }}">
                                                    {% else %}
                                                        <div class="admin-pro-user-small-placeholder">
                                                            {{ transaction.user.get_initials }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="admin-pro-user-small-content">
                                                    {{ transaction.user.get_full_name|default:transaction.user.email }}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="admin-pro-book-item">
                                                <div class="admin-pro-book-title">{{ transaction.book_copy.book.title|truncatechars:30 }}</div>
                                                <div class="admin-pro-book-id">ID: {{ transaction.book_copy.inventory_number }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if transaction.transaction_type == 'BORROW' %}
                                                <span class="admin-pro-badge admin-pro-badge-primary">Borrow</span>
                                            {% elif transaction.transaction_type == 'RETURN' %}
                                                <span class="admin-pro-badge admin-pro-badge-success">Return</span>
                                            {% elif transaction.transaction_type == 'RESERVE' %}
                                                <span class="admin-pro-badge admin-pro-badge-warning">Reserve</span>
                                            {% else %}
                                                <span class="admin-pro-badge admin-pro-badge-info">{{ transaction.transaction_type|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if transaction.status == 'COMPLETED' %}
                                                <span class="admin-pro-badge admin-pro-badge-success">Completed</span>
                                            {% elif transaction.status == 'PENDING' %}
                                                <span class="admin-pro-badge admin-pro-badge-warning">Pending</span>
                                            {% elif transaction.status == 'OVERDUE' %}
                                                <span class="admin-pro-badge admin-pro-badge-danger">Overdue</span>
                                            {% else %}
                                                <span class="admin-pro-badge admin-pro-badge-info">{{ transaction.status|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="admin-pro-table-actions">
                                                <a href="{% url 'transactions:transaction_detail' transaction_id=transaction.transaction_id %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-info admin-pro-btn-icon" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="admin-pro-empty-state">
                                                <div class="admin-pro-empty-icon">
                                                    <i class="fas fa-exchange-alt"></i>
                                                </div>
                                                <h4>No Transactions Yet</h4>
                                                <p>Transactions will appear here as they are created.</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Members -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-pro-card">
                <div class="admin-pro-card-header d-flex justify-content-between align-items-center">
                    <h3 class="admin-pro-card-title">
                        <i class="fas fa-users me-2 text-info"></i>Staff Members
                    </h3>
                    <div class="admin-pro-card-actions">
                        <a href="{% url 'libraries:manage_library_staff' slug=library.slug %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-primary">
                            <i class="fas fa-user-plus"></i> Add Staff
                        </a>
                        <a href="{% url 'libraries:manage_library_staff' slug=library.slug %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-outline">
                            <i class="fas fa-cog"></i> Manage All
                        </a>
                    </div>
                </div>
                <div class="admin-pro-card-body">
                    <div class="row">
                        {% for staff in staff_members %}
                            <div class="col-md-4 mb-3">
                                <div class="admin-pro-staff-card">
                                    <div class="admin-pro-staff-header">
                                        <div class="admin-pro-staff-avatar">
                                            {% if staff.profile_picture %}
                                                <img src="{{ staff.profile_picture.url }}" alt="{{ staff.get_full_name }}">
                                            {% else %}
                                                <div class="admin-pro-staff-avatar-placeholder">
                                                    {{ staff.get_initials }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="admin-pro-staff-info">
                                            <h4 class="admin-pro-staff-name">{{ staff.get_full_name|default:"Staff Member" }}</h4>
                                            <p class="admin-pro-staff-email">{{ staff.email }}</p>
                                        </div>
                                    </div>
                                    <div class="admin-pro-staff-details">
                                        {% if staff.phone_number %}
                                            <div class="admin-pro-staff-detail-item">
                                                <div class="admin-pro-staff-detail-icon">
                                                    <i class="fas fa-phone"></i>
                                                </div>
                                                <div class="admin-pro-staff-detail-content">
                                                    {{ staff.phone_number }}
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div class="admin-pro-staff-detail-item">
                                            <div class="admin-pro-staff-detail-icon">
                                                <i class="fas fa-calendar-alt"></i>
                                            </div>
                                            <div class="admin-pro-staff-detail-content">
                                                Joined: {{ staff.date_joined|date:"M d, Y" }}
                                            </div>
                                        </div>
                                        <div class="admin-pro-staff-detail-item">
                                            <div class="admin-pro-staff-detail-icon">
                                                <i class="fas fa-id-badge"></i>
                                            </div>
                                            <div class="admin-pro-staff-detail-content">
                                                Role: {{ staff.get_role_display|default:"Staff" }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="admin-pro-staff-actions">
                                        <a href="{% url 'accounts:user_profile' user_id=staff.id %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-outline admin-pro-btn-block">
                                            <i class="fas fa-eye me-1"></i> View Profile
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="col-12">
                                <div class="admin-pro-empty-state">
                                    <div class="admin-pro-empty-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h4>No Staff Members Yet</h4>
                                    <p>Add staff members to help manage your library.</p>
                                    <a href="{% url 'libraries:manage_library_staff' slug=library.slug %}" class="admin-pro-btn admin-pro-btn-primary mt-3">
                                        <i class="fas fa-user-plus me-1"></i> Add Staff
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Book Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="admin-pro-card">
                <div class="admin-pro-card-header d-flex justify-content-between align-items-center">
                    <h3 class="admin-pro-card-title">
                        <i class="fas fa-book-open me-2 text-success"></i>Book Status
                    </h3>
                    <div class="admin-pro-card-actions">
                        <a href="{% url 'books:manage_book_copies' %}" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-outline">
                            <i class="fas fa-cog"></i> Manage Books
                        </a>
                    </div>
                </div>
                <div class="admin-pro-card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="admin-pro-status-card success">
                                <div class="admin-pro-status-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="admin-pro-status-content">
                                    <h3 class="admin-pro-status-value">{{ book_copies.filter.status.AVAILABLE.count }}</h3>
                                    <p class="admin-pro-status-label">Available Books</p>
                                </div>
                                <div class="admin-pro-status-progress">
                                    <div class="admin-pro-status-bar success" style="width: {% widthratio book_copies.filter.status.AVAILABLE.count book_copies.count 100 %}%;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="admin-pro-status-card danger">
                                <div class="admin-pro-status-icon">
                                    <i class="fas fa-book-reader"></i>
                                </div>
                                <div class="admin-pro-status-content">
                                    <h3 class="admin-pro-status-value">{{ book_copies.filter.status.BORROWED.count }}</h3>
                                    <p class="admin-pro-status-label">Borrowed Books</p>
                                </div>
                                <div class="admin-pro-status-progress">
                                    <div class="admin-pro-status-bar danger" style="width: {% widthratio book_copies.filter.status.BORROWED.count book_copies.count 100 %}%;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="admin-pro-status-card warning">
                                <div class="admin-pro-status-icon">
                                    <i class="fas fa-bookmark"></i>
                                </div>
                                <div class="admin-pro-status-content">
                                    <h3 class="admin-pro-status-value">{{ book_copies.filter.status.RESERVED.count }}</h3>
                                    <p class="admin-pro-status-label">Reserved Books</p>
                                </div>
                                <div class="admin-pro-status-progress">
                                    <div class="admin-pro-status-bar warning" style="width: {% widthratio book_copies.filter.status.RESERVED.count book_copies.count 100 %}%;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="admin-pro-status-card info">
                                <div class="admin-pro-status-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="admin-pro-status-content">
                                    <h3 class="admin-pro-status-value">{{ book_copies.filter.status.MAINTENANCE.count }}</h3>
                                    <p class="admin-pro-status-label">In Maintenance</p>
                                </div>
                                <div class="admin-pro-status-progress">
                                    <div class="admin-pro-status-bar info" style="width: {% widthratio book_copies.filter.status.MAINTENANCE.count book_copies.count 100 %}%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
