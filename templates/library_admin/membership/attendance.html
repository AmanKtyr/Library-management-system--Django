{% extends 'library_admin/base.html' %}
{% load static %}

{% block title %}Reading Hall Attendance - Library Management System{% endblock %}
{% block breadcrumb_title %}Reading Hall Attendance{% endblock %}
{% block page_title %}Reading Hall Attendance{% endblock %}

{% block page_actions %}
<div class="d-flex flex-wrap gap-2">
    <a href="{% url 'library_admin:attendance_report' %}" class="admin-pro-btn admin-pro-btn-outline">
        <i class="fas fa-chart-bar"></i> Attendance Report
    </a>
    <a href="{% url 'library_admin:members' %}" class="admin-pro-btn admin-pro-btn-outline">
        <i class="fas fa-users"></i> Manage Members
    </a>
    <button type="button" class="admin-pro-btn admin-pro-btn-outline" id="exportAttendanceBtn">
        <i class="fas fa-file-export"></i> Export Data
    </button>
    <button type="button" class="admin-pro-btn admin-pro-btn-outline" data-bs-toggle="modal" data-bs-target="#scannerModal">
        <i class="fas fa-id-card"></i> Scan ID Card
    </button>
    <button type="button" class="admin-pro-btn admin-pro-btn-outline" id="printReportBtn">
        <i class="fas fa-print"></i> Print Report
    </button>
    <button type="button" class="admin-pro-btn admin-pro-btn-primary" data-bs-toggle="modal" data-bs-target="#checkInModal">
        <i class="fas fa-user-check"></i> Check In Member
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Attendance Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="admin-pro-card admin-pro-card-stats">
            <div class="admin-pro-card-body">
                <div class="admin-pro-stats-icon bg-primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="admin-pro-stats-content">
                    <h3>{{ today_attendance|default:"0" }}</h3>
                    <p>Today's Visitors</p>
                </div>
            </div>
            <div class="admin-pro-card-footer text-center">
                <small class="text-muted">{{ yesterday_attendance|default:"0" }} yesterday</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="admin-pro-card admin-pro-card-stats">
            <div class="admin-pro-card-body">
                <div class="admin-pro-stats-icon bg-success">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="admin-pro-stats-content">
                    <h3>{{ current_attendance|default:"0" }}</h3>
                    <p>Currently In Hall</p>
                </div>
            </div>
            <div class="admin-pro-card-footer text-center">
                <small class="text-muted">{{ capacity|default:"50" }} total capacity</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="admin-pro-card admin-pro-card-stats">
            <div class="admin-pro-card-body">
                <div class="admin-pro-stats-icon bg-info">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="admin-pro-stats-content">
                    <h3>{{ avg_duration|default:"0" }} min</h3>
                    <p>Avg. Study Time</p>
                </div>
            </div>
            <div class="admin-pro-card-footer text-center">
                <small class="text-muted">{{ max_duration|default:"240" }} min longest today</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="admin-pro-card admin-pro-card-stats">
            <div class="admin-pro-card-body">
                <div class="admin-pro-stats-icon bg-warning">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="admin-pro-stats-content">
                    <h3>{{ weekly_attendance|default:"0" }}</h3>
                    <p>This Week</p>
                </div>
            </div>
            <div class="admin-pro-card-footer text-center">
                <small class="text-muted">{{ weekly_change|default:"+12%" }} vs last week</small>
            </div>
        </div>
    </div>
</div>

<!-- Seating Chart -->
<div class="admin-pro-card mb-4">
    <div class="admin-pro-card-header d-flex justify-content-between align-items-center">
        <h5 class="admin-pro-card-title"><i class="fas fa-th me-2"></i>Reading Hall Seating Chart</h5>
        <div class="admin-pro-card-toolbar">
            <button type="button" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-outline" id="toggleSeatingView">
                <i class="fas fa-sync-alt"></i> Toggle View
            </button>
        </div>
    </div>
    <div class="admin-pro-card-body">
        <div class="seating-chart-container">
            <div class="seating-chart-legend mb-3">
                <span class="seating-legend-item"><span class="seat-indicator available"></span> Available</span>
                <span class="seating-legend-item"><span class="seat-indicator occupied"></span> Occupied</span>
                <span class="seating-legend-item"><span class="seat-indicator reserved"></span> Reserved</span>
                <span class="seating-legend-item"><span class="seat-indicator maintenance"></span> Maintenance</span>
            </div>

            <div class="seating-chart" id="seatingChart">
                <!-- Reading Hall Layout -->
                <div class="reading-hall-layout">
                    <!-- Entrance -->
                    <div class="entrance-area">
                        <div class="entrance-label">Entrance</div>
                        <div class="entrance-icon"><i class="fas fa-door-open"></i></div>
                    </div>

                    <!-- Librarian Desk -->
                    <div class="librarian-desk">
                        <div class="desk-label">Librarian</div>
                    </div>

                    <!-- Reading Tables -->
                    <div class="reading-tables">
                        <!-- Row 1 -->
                        <div class="table-row">
                            <div class="reading-table">
                                <div class="seat seat-1" data-seat="A1" data-status="available" data-toggle="tooltip" title="Seat A1: Available"></div>
                                <div class="seat seat-2" data-seat="A2" data-status="occupied" data-member="Rahul S." data-toggle="tooltip" title="Seat A2: Occupied by Rahul S."></div>
                                <div class="table-label">A</div>
                                <div class="seat seat-3" data-seat="A3" data-status="occupied" data-member="Priya M." data-toggle="tooltip" title="Seat A3: Occupied by Priya M."></div>
                                <div class="seat seat-4" data-seat="A4" data-status="available" data-toggle="tooltip" title="Seat A4: Available"></div>
                            </div>

                            <div class="reading-table">
                                <div class="seat seat-1" data-seat="B1" data-status="available" data-toggle="tooltip" title="Seat B1: Available"></div>
                                <div class="seat seat-2" data-seat="B2" data-status="available" data-toggle="tooltip" title="Seat B2: Available"></div>
                                <div class="table-label">B</div>
                                <div class="seat seat-3" data-seat="B3" data-status="occupied" data-member="Amit K." data-toggle="tooltip" title="Seat B3: Occupied by Amit K."></div>
                                <div class="seat seat-4" data-seat="B4" data-status="maintenance" data-toggle="tooltip" title="Seat B4: Under maintenance"></div>
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div class="table-row">
                            <div class="reading-table">
                                <div class="seat seat-1" data-seat="C1" data-status="occupied" data-member="Neha G." data-toggle="tooltip" title="Seat C1: Occupied by Neha G."></div>
                                <div class="seat seat-2" data-seat="C2" data-status="available" data-toggle="tooltip" title="Seat C2: Available"></div>
                                <div class="table-label">C</div>
                                <div class="seat seat-3" data-seat="C3" data-status="available" data-toggle="tooltip" title="Seat C3: Available"></div>
                                <div class="seat seat-4" data-seat="C4" data-status="reserved" data-toggle="tooltip" title="Seat C4: Reserved"></div>
                            </div>

                            <div class="reading-table">
                                <div class="seat seat-1" data-seat="D1" data-status="occupied" data-member="Vikram S." data-toggle="tooltip" title="Seat D1: Occupied by Vikram S."></div>
                                <div class="seat seat-2" data-seat="D2" data-status="occupied" data-member="Anjali P." data-toggle="tooltip" title="Seat D2: Occupied by Anjali P."></div>
                                <div class="table-label">D</div>
                                <div class="seat seat-3" data-seat="D3" data-status="available" data-toggle="tooltip" title="Seat D3: Available"></div>
                                <div class="seat seat-4" data-seat="D4" data-status="available" data-toggle="tooltip" title="Seat D4: Available"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Newspaper Section -->
                    <div class="newspaper-section">
                        <div class="section-label">Newspaper Section</div>
                        <div class="newspaper-seats">
                            <div class="seat newspaper-seat" data-seat="N1" data-status="occupied" data-member="Rajesh T." data-toggle="tooltip" title="Newspaper Seat 1: Occupied by Rajesh T."></div>
                            <div class="seat newspaper-seat" data-seat="N2" data-status="available" data-toggle="tooltip" title="Newspaper Seat 2: Available"></div>
                            <div class="seat newspaper-seat" data-seat="N3" data-status="available" data-toggle="tooltip" title="Newspaper Seat 3: Available"></div>
                            <div class="seat newspaper-seat" data-seat="N4" data-status="occupied" data-member="Sanjay V." data-toggle="tooltip" title="Newspaper Seat 4: Occupied by Sanjay V."></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Analytics -->
<div class="admin-pro-card mb-4">
    <div class="admin-pro-card-header d-flex justify-content-between align-items-center">
        <h5 class="admin-pro-card-title"><i class="fas fa-chart-bar me-2"></i>Reading Hall Analytics</h5>
        <div class="admin-pro-card-toolbar">
            <select class="form-select form-select-sm" id="analyticsTimeRange">
                <option value="today">Today</option>
                <option value="week" selected>This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
    </div>
    <div class="admin-pro-card-body">
        <div class="row">
            <!-- Hourly Attendance Chart -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Hourly Attendance</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="hourlyAttendanceChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Purpose Distribution Chart -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Purpose Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="purposeDistributionChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Visitors -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Top Visitors</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Member</th>
                                    <th>Visits</th>
                                    <th>Total Hours</th>
                                    <th>Avg. Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Rahul Sharma</td>
                                    <td>15</td>
                                    <td>45.5</td>
                                    <td>3h 2m</td>
                                </tr>
                                <tr>
                                    <td>Priya Mehta</td>
                                    <td>12</td>
                                    <td>42.0</td>
                                    <td>3h 30m</td>
                                </tr>
                                <tr>
                                    <td>Amit Kumar</td>
                                    <td>10</td>
                                    <td>35.5</td>
                                    <td>3h 33m</td>
                                </tr>
                                <tr>
                                    <td>Neha Gupta</td>
                                    <td>9</td>
                                    <td>27.0</td>
                                    <td>3h 0m</td>
                                </tr>
                                <tr>
                                    <td>Vikram Singh</td>
                                    <td>8</td>
                                    <td>24.0</td>
                                    <td>3h 0m</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Peak Hours -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Peak Hours & Capacity Planning</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Peak Hours</h6>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>10:00 AM - 12:00 PM</span>
                                <span class="badge bg-danger">85% Full</span>
                            </div>
                            <div class="progress mb-3" style="height: 10px;">
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 85%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>2:00 PM - 4:00 PM</span>
                                <span class="badge bg-warning">70% Full</span>
                            </div>
                            <div class="progress mb-3" style="height: 10px;">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 70%;" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>4:00 PM - 6:00 PM</span>
                                <span class="badge bg-success">55% Full</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 55%;" aria-valuenow="55" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i> Consider adding 5 more seats during peak hours (10 AM - 12 PM) to accommodate demand.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="admin-pro-card mb-4">
    <div class="admin-pro-card-header">
        <h5 class="admin-pro-card-title">Reading Hall Attendance Register</h5>
        <div class="admin-pro-card-toolbar">
            <form action="{% url 'library_admin:member_attendance' %}" method="GET" class="admin-pro-search-form">
                <div class="input-group">
                    <input type="text" name="q" class="form-control" placeholder="Search members..." value="{{ search_query }}">
                    <input type="date" name="date" class="form-control" value="{{ date_filter }}" max="{{ today|date:'Y-m-d' }}">
                    <select name="purpose" class="form-select">
                        <option value="">All Purposes</option>
                        <option value="Self Study" {% if purpose_filter == 'Self Study' %}selected{% endif %}>Self Study</option>
                        <option value="Exam Preparation" {% if purpose_filter == 'Exam Preparation' %}selected{% endif %}>Exam Preparation</option>
                        <option value="Reading Newspapers" {% if purpose_filter == 'Reading Newspapers' %}selected{% endif %}>Reading Newspapers</option>
                        <option value="Using WiFi" {% if purpose_filter == 'Using WiFi' %}selected{% endif %}>Using WiFi</option>
                        <option value="Competitive Exam Preparation" {% if purpose_filter == 'Competitive Exam Preparation' %}selected{% endif %}>Competitive Exam Preparation</option>
                    </select>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="mt-2 d-flex flex-wrap gap-2">
                    <a href="{% url 'library_admin:member_attendance' %}?date={{ today|date:'Y-m-d' }}" class="btn btn-sm btn-outline-primary">Today</a>
                    <a href="{% url 'library_admin:member_attendance' %}?purpose=Self+Study" class="btn btn-sm btn-outline-primary">Self Study</a>
                    <a href="{% url 'library_admin:member_attendance' %}?purpose=Exam+Preparation" class="btn btn-sm btn-outline-primary">Exam Prep</a>
                    <a href="{% url 'library_admin:member_attendance' %}?purpose=Competitive+Exam+Preparation" class="btn btn-sm btn-outline-primary">Competitive Exams</a>
                    <a href="{% url 'library_admin:member_attendance' %}?purpose=Reading+Newspapers" class="btn btn-sm btn-outline-primary">Newspapers</a>
                </div>
            </form>
        </div>
    </div>
    <div class="admin-pro-card-body">
        {% if attendances %}
            <div class="table-responsive">
                <table class="table table-hover admin-pro-table" id="attendanceTable">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Member</th>
                            <th style="width: 15%;">Check In</th>
                            <th style="width: 15%;">Check Out</th>
                            <th style="width: 10%;">Duration</th>
                            <th style="width: 20%;">Purpose</th>
                            <th style="width: 15%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attendance in attendances %}
                            <tr class="{% if not attendance.check_out_time %}table-success{% endif %}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="admin-pro-table-item-icon bg-primary">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="ms-2">
                                            <h6 class="mb-0">{{ attendance.user.get_full_name }}</h6>
                                            <small class="text-muted">{{ attendance.user.email }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ attendance.check_in_time|date:"M d, Y" }}<br>{{ attendance.check_in_time|time:"h:i A" }}</td>
                                <td>
                                    {% if attendance.check_out_time %}
                                        {{ attendance.check_out_time|date:"M d, Y" }}<br>{{ attendance.check_out_time|time:"h:i A" }}
                                    {% else %}
                                        <span class="badge bg-success">Currently In</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if attendance.duration %}
                                        {{ attendance.duration }} minutes
                                    {% else %}
                                        <span class="badge bg-warning">In Progress</span>
                                    {% endif %}
                                </td>
                                <td>{{ attendance.purpose|default:"Not specified" }}</td>
                                <td>
                                    {% if not attendance.check_out_time %}
                                        <form method="POST" action="{% url 'library_admin:record_attendance' %}" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="check_out">
                                            <input type="hidden" name="attendance_id" value="{{ attendance.id }}">
                                            <button type="submit" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-success" data-tooltip="Check Out">
                                                <i class="fas fa-sign-out-alt"></i> Check Out
                                            </button>
                                        </form>
                                    {% else %}
                                        <button type="button" class="admin-pro-btn admin-pro-btn-sm admin-pro-btn-secondary" disabled>
                                            <i class="fas fa-check"></i> Completed
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="admin-pro-empty-state">
                <div class="admin-pro-empty-state-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3>No Reading Hall Attendance Records Found</h3>
                <p>There are no students currently using the reading hall or no records matching your search criteria.</p>
                <button type="button" class="admin-pro-btn admin-pro-btn-primary" data-bs-toggle="modal" data-bs-target="#checkInModal">
                    <i class="fas fa-user-check"></i> Check In Member
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Check In Modal -->
<div class="modal fade" id="checkInModal" tabindex="-1" aria-labelledby="checkInModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="checkInModalLabel"><i class="fas fa-user-check me-2"></i>Register Student in Reading Hall</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'library_admin:record_attendance' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="check_in">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="member_id" class="form-label">Select Member <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <select class="form-select" id="member_id" name="member_id" required>
                                        <option value="">-- Select Member --</option>
                                        {% for member in active_members %}
                                            <option value="{{ member.id }}">{{ member.get_full_name }} ({{ member.email }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <small class="form-text text-muted">Only active members with valid plans are shown</small>
                            </div>

                            <div class="form-group mb-3">
                                <label for="purpose" class="form-label">Purpose <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tasks"></i></span>
                                    <select class="form-select" id="purpose" name="purpose" required>
                                        <option value="">-- Select Purpose --</option>
                                        <option value="Self Study">Self Study</option>
                                        <option value="Exam Preparation">Exam Preparation</option>
                                        <option value="Reading Newspapers">Reading Newspapers</option>
                                        <option value="Reading Books">Reading Books</option>
                                        <option value="Using WiFi">Using WiFi</option>
                                        <option value="Borrowing Books">Borrowing Books</option>
                                        <option value="Returning Books">Returning Books</option>
                                        <option value="Research">Research</option>
                                        <option value="Group Study">Group Study</option>
                                        <option value="Using Reference Materials">Using Reference Materials</option>
                                        <option value="Competitive Exam Preparation">Competitive Exam Preparation</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="seat_number" class="form-label">Seat Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-chair"></i></span>
                                    <input type="text" class="form-control" id="seat_number" name="seat_number" placeholder="Optional">
                                </div>
                                <small class="form-text text-muted">Assign a specific seat if applicable</small>
                            </div>

                            <div class="form-group mb-3">
                                <label for="expected_duration" class="form-label">Expected Duration (hours)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                    <select class="form-select" id="expected_duration" name="expected_duration">
                                        <option value="">-- Select Duration --</option>
                                        <option value="1">1 hour</option>
                                        <option value="2">2 hours</option>
                                        <option value="3">3 hours</option>
                                        <option value="4">4 hours</option>
                                        <option value="5">5 hours</option>
                                        <option value="6">6+ hours</option>
                                        <option value="full_day">Full Day</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Any special requirements or additional information"></textarea>
                    </div>

                    <div class="alert alert-info">
                        <div class="d-flex">
                            <div class="me-2">
                                <i class="fas fa-info-circle fa-2x"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading mb-1">Reading Hall Rules</h6>
                                <ul class="mb-0 ps-3 small">
                                    <li>Maintain silence in the reading area</li>
                                    <li>Mobile phones must be on silent mode</li>
                                    <li>No food or drinks allowed (except water)</li>
                                    <li>Handle library materials with care</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-user-check"></i> Check In
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize select2 for member selection if available
        if (typeof $.fn.select2 !== 'undefined') {
            $('#member_id').select2({
                dropdownParent: $('#checkInModal'),
                placeholder: "Search for a member...",
                allowClear: true
            });

            // Initialize purpose select with select2
            $('#purpose').select2({
                dropdownParent: $('#checkInModal'),
                placeholder: "Select purpose of visit",
                allowClear: true
            });
        }

        // Handle export button click
        const exportBtn = document.getElementById('exportAttendanceBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                // Get current date in YYYY-MM-DD format
                const today = new Date();
                const date = today.getFullYear() + '-' +
                      String(today.getMonth() + 1).padStart(2, '0') + '-' +
                      String(today.getDate()).padStart(2, '0');

                // Create a CSV from the table data
                const table = document.getElementById('attendanceTable');
                if (!table) {
                    alert('No attendance data to export');
                    return;
                }

                let csv = [];
                const rows = table.querySelectorAll('tr');

                // Add header row
                const headerRow = [];
                const headers = rows[0].querySelectorAll('th');
                for (let i = 0; i < headers.length - 1; i++) { // Skip the Actions column
                    headerRow.push('"' + headers[i].innerText.trim() + '"');
                }
                csv.push(headerRow.join(','));

                // Add data rows
                for (let i = 1; i < rows.length; i++) {
                    const row = [];
                    const cols = rows[i].querySelectorAll('td');

                    // Skip the last column (Actions)
                    for (let j = 0; j < cols.length - 1; j++) {
                        // Clean up the text content
                        let cellText = cols[j].innerText.trim().replace(/\n/g, ' ');
                        row.push('"' + cellText + '"');
                    }

                    csv.push(row.join(','));
                }

                // Create and trigger download
                const csvContent = csv.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', `reading_hall_attendance_${date}.csv`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // Highlight currently checked-in members
        const currentlyInRows = document.querySelectorAll('tr.table-success');
        if (currentlyInRows.length > 0) {
            // Add a pulsing effect to currently checked in members
            currentlyInRows.forEach(row => {
                row.classList.add('attendance-active-pulse');
            });
        }

        // Add row highlighting on hover
        const tableRows = document.querySelectorAll('#attendanceTable tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.classList.add('row-highlight');
            });
            row.addEventListener('mouseleave', function() {
                this.classList.remove('row-highlight');
            });
        });

        // Initialize tooltips if Bootstrap's tooltip is available
        if (typeof bootstrap !== 'undefined' && typeof bootstrap.Tooltip !== 'undefined') {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Handle seating chart interactions
        const seats = document.querySelectorAll('.seat');
        const toggleViewBtn = document.getElementById('toggleSeatingView');

        // Create a list view element for mobile/alternative view
        const seatingChart = document.getElementById('seatingChart');
        const listView = document.createElement('div');
        listView.className = 'seating-list-view';
        listView.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Seat</th>
                            <th>Status</th>
                            <th>Member</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="seatListBody">
                    </tbody>
                </table>
            </div>
        `;
        seatingChart.appendChild(listView);

        // Populate the list view
        const seatListBody = document.getElementById('seatListBody');
        seats.forEach(seat => {
            const seatId = seat.getAttribute('data-seat');
            const status = seat.getAttribute('data-status');
            const member = seat.getAttribute('data-member') || '-';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${seatId}</td>
                <td>
                    <span class="badge ${status === 'available' ? 'bg-success' :
                                        status === 'occupied' ? 'bg-danger' :
                                        status === 'reserved' ? 'bg-warning' : 'bg-secondary'}">
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td>${member}</td>
                <td>
                    ${status === 'occupied' ?
                        `<button class="btn btn-sm btn-outline-success checkout-btn" data-seat="${seatId}">
                            <i class="fas fa-sign-out-alt"></i> Check Out
                        </button>` :
                        status === 'available' ?
                        `<button class="btn btn-sm btn-outline-primary checkin-btn" data-seat="${seatId}">
                            <i class="fas fa-sign-in-alt"></i> Assign
                        </button>` :
                        `<button class="btn btn-sm btn-outline-secondary" disabled>
                            ${status === 'reserved' ? 'Reserved' : 'Unavailable'}
                        </button>`
                    }
                </td>
            `;
            seatListBody.appendChild(tr);
        });

        // Toggle between chart and list view
        if (toggleViewBtn) {
            toggleViewBtn.addEventListener('click', function() {
                const layout = document.querySelector('.reading-hall-layout');
                const listView = document.querySelector('.seating-list-view');

                if (layout.classList.contains('inactive')) {
                    layout.classList.remove('inactive');
                    listView.classList.remove('active');
                    toggleViewBtn.innerHTML = '<i class="fas fa-list"></i> List View';
                } else {
                    layout.classList.add('inactive');
                    listView.classList.add('active');
                    toggleViewBtn.innerHTML = '<i class="fas fa-th"></i> Chart View';
                }
            });
        }

        // Handle seat click events
        seats.forEach(seat => {
            seat.addEventListener('click', function() {
                const seatId = this.getAttribute('data-seat');
                const status = this.getAttribute('data-status');
                const member = this.getAttribute('data-member');

                if (status === 'available') {
                    // Show check-in modal with pre-selected seat
                    const modal = new bootstrap.Modal(document.getElementById('checkInModal'));
                    const seatNumberInput = document.getElementById('seat_number');
                    if (seatNumberInput) {
                        seatNumberInput.value = seatId;
                    }
                    modal.show();
                } else if (status === 'occupied') {
                    // Show confirmation dialog for checkout
                    if (confirm(`Do you want to check out ${member || 'the member'} from seat ${seatId}?`)) {
                        // In a real implementation, you would submit a form or make an AJAX call
                        alert(`Member checked out from seat ${seatId}`);
                    }
                } else if (status === 'reserved') {
                    // Show options for reserved seat
                    const action = prompt(`Seat ${seatId} is reserved. What would you like to do?\n1. Cancel reservation\n2. Check in member\n3. Do nothing`);
                    if (action === '1') {
                        alert(`Reservation for seat ${seatId} cancelled`);
                    } else if (action === '2') {
                        const modal = new bootstrap.Modal(document.getElementById('checkInModal'));
                        const seatNumberInput = document.getElementById('seat_number');
                        if (seatNumberInput) {
                            seatNumberInput.value = seatId;
                        }
                        modal.show();
                    }
                }
            });
        });

        // Add real-time attendance tracking simulation
        let simulationInterval;

        function startAttendanceSimulation() {
            // Update the current time every minute
            const timeDisplay = document.createElement('div');
            timeDisplay.className = 'text-center mb-3';
            timeDisplay.id = 'currentTimeDisplay';

            const seatingChartContainer = document.querySelector('.seating-chart-container');
            seatingChartContainer.insertBefore(timeDisplay, seatingChartContainer.firstChild);

            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                timeDisplay.innerHTML = `<strong>Current Time:</strong> ${timeString} | <strong>Occupancy:</strong> <span id="occupancyRate">7/16</span> seats`;

                // Randomly update seat status for simulation
                if (Math.random() > 0.8) {
                    const availableSeats = Array.from(document.querySelectorAll('.seat[data-status="available"]'));
                    const occupiedSeats = Array.from(document.querySelectorAll('.seat[data-status="occupied"]'));

                    if (availableSeats.length > 0 && Math.random() > 0.5) {
                        // Randomly occupy a seat
                        const randomSeat = availableSeats[Math.floor(Math.random() * availableSeats.length)];
                        const seatId = randomSeat.getAttribute('data-seat');
                        const names = ['Ananya K.', 'Rohan M.', 'Divya S.', 'Arjun P.', 'Meera R.'];
                        const randomName = names[Math.floor(Math.random() * names.length)];

                        randomSeat.setAttribute('data-status', 'occupied');
                        randomSeat.setAttribute('data-member', randomName);
                        randomSeat.setAttribute('title', `Seat ${seatId}: Occupied by ${randomName}`);

                        // Update the list view
                        const listRow = document.querySelector(`#seatListBody tr:nth-child(${Array.from(seats).indexOf(randomSeat) + 1})`);
                        if (listRow) {
                            listRow.cells[1].innerHTML = '<span class="badge bg-danger">Occupied</span>';
                            listRow.cells[2].textContent = randomName;
                            listRow.cells[3].innerHTML = `
                                <button class="btn btn-sm btn-outline-success checkout-btn" data-seat="${seatId}">
                                    <i class="fas fa-sign-out-alt"></i> Check Out
                                </button>
                            `;
                        }
                    } else if (occupiedSeats.length > 0 && Math.random() > 0.7) {
                        // Randomly vacate a seat
                        const randomSeat = occupiedSeats[Math.floor(Math.random() * occupiedSeats.length)];
                        const seatId = randomSeat.getAttribute('data-seat');

                        randomSeat.setAttribute('data-status', 'available');
                        randomSeat.removeAttribute('data-member');
                        randomSeat.setAttribute('title', `Seat ${seatId}: Available`);

                        // Update the list view
                        const listRow = document.querySelector(`#seatListBody tr:nth-child(${Array.from(seats).indexOf(randomSeat) + 1})`);
                        if (listRow) {
                            listRow.cells[1].innerHTML = '<span class="badge bg-success">Available</span>';
                            listRow.cells[2].textContent = '-';
                            listRow.cells[3].innerHTML = `
                                <button class="btn btn-sm btn-outline-primary checkin-btn" data-seat="${seatId}">
                                    <i class="fas fa-sign-in-alt"></i> Assign
                                </button>
                            `;
                        }
                    }

                    // Update occupancy rate
                    const currentOccupied = document.querySelectorAll('.seat[data-status="occupied"]').length;
                    const totalSeats = document.querySelectorAll('.seat').length;
                    document.getElementById('occupancyRate').textContent = `${currentOccupied}/${totalSeats}`;
                }
            }

            updateTime(); // Initial call
            simulationInterval = setInterval(updateTime, 10000); // Update every 10 seconds for demo
        }

        // Start the simulation
        startAttendanceSimulation();

        // Initialize charts if Chart.js is available
        if (typeof Chart !== 'undefined') {
            // Hourly Attendance Chart
            const hourlyCtx = document.getElementById('hourlyAttendanceChart');
            if (hourlyCtx) {
                new Chart(hourlyCtx, {
                    type: 'line',
                    data: {
                        labels: ['8 AM', '9 AM', '10 AM', '11 AM', '12 PM', '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM'],
                        datasets: [{
                            label: 'Number of Members',
                            data: [5, 12, 18, 20, 15, 10, 14, 16, 12, 8, 5, 2],
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Members'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour of Day'
                                }
                            }
                        }
                    }
                });
            }

            // Purpose Distribution Chart
            const purposeCtx = document.getElementById('purposeDistributionChart');
            if (purposeCtx) {
                new Chart(purposeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Self Study', 'Exam Preparation', 'Reading Newspapers', 'Using WiFi', 'Competitive Exams'],
                        datasets: [{
                            data: [35, 25, 15, 10, 15],
                            backgroundColor: [
                                '#0d6efd',
                                '#6f42c1',
                                '#fd7e14',
                                '#20c997',
                                '#dc3545'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${percentage}% (${value})`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        } else {
            // If Chart.js is not available, show a message
            const chartContainers = document.querySelectorAll('.card-body canvas');
            chartContainers.forEach(container => {
                container.parentNode.innerHTML = `
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i> Chart.js library is required to display charts.
                    </div>
                `;
            });
        }

        // Handle analytics time range change
        const analyticsTimeRange = document.getElementById('analyticsTimeRange');
        if (analyticsTimeRange) {
            analyticsTimeRange.addEventListener('change', function() {
                const value = this.value;
                // In a real implementation, you would fetch data for the selected time range
                // For now, we'll just show an alert
                alert(`Analytics data will be updated for: ${value}`);
            });
        }
    });
</script>

<style>
    /* Custom styles for attendance page */
    .attendance-active-pulse {
        animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }

    .row-highlight {
        background-color: rgba(0, 123, 255, 0.05) !important;
        transition: background-color 0.2s ease;
    }

    /* Stats card hover effect */
    .admin-pro-card-stats {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .admin-pro-card-stats:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Seating Chart Styles */
    .seating-chart-container {
        padding: 10px;
        overflow-x: auto;
    }

    .seating-chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 15px;
    }

    .seating-legend-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
    }

    .seat-indicator {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 3px;
        margin-right: 5px;
    }

    .seat-indicator.available {
        background-color: #28a745;
    }

    .seat-indicator.occupied {
        background-color: #dc3545;
    }

    .seat-indicator.reserved {
        background-color: #ffc107;
    }

    .seat-indicator.maintenance {
        background-color: #6c757d;
    }

    .reading-hall-layout {
        display: grid;
        grid-template-columns: 1fr 4fr;
        grid-template-rows: auto 1fr;
        gap: 20px;
        min-height: 400px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .entrance-area {
        grid-column: 1;
        grid-row: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 1px dashed #6c757d;
        padding: 10px;
        border-radius: 5px;
    }

    .entrance-icon {
        font-size: 24px;
        color: #6c757d;
    }

    .librarian-desk {
        grid-column: 1;
        grid-row: 2;
        background-color: #e9ecef;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        border: 1px solid #ced4da;
    }

    .desk-label {
        font-weight: bold;
        transform: rotate(-90deg);
    }

    .reading-tables {
        grid-column: 2;
        grid-row: 1 / span 2;
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    .table-row {
        display: flex;
        justify-content: space-around;
        gap: 40px;
    }

    .reading-table {
        position: relative;
        width: 200px;
        height: 120px;
        background-color: #e9ecef;
        border-radius: 5px;
        border: 2px solid #ced4da;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        padding: 5px;
        gap: 5px;
    }

    .table-label {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        font-size: 18px;
        color: #6c757d;
    }

    .seat {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .seat[data-status="available"] {
        background-color: #28a745;
    }

    .seat[data-status="occupied"] {
        background-color: #dc3545;
    }

    .seat[data-status="reserved"] {
        background-color: #ffc107;
    }

    .seat[data-status="maintenance"] {
        background-color: #6c757d;
    }

    .seat-1 {
        justify-self: start;
        align-self: start;
    }

    .seat-2 {
        justify-self: end;
        align-self: start;
    }

    .seat-3 {
        justify-self: start;
        align-self: end;
    }

    .seat-4 {
        justify-self: end;
        align-self: end;
    }

    .newspaper-section {
        grid-column: 2;
        grid-row: 3;
        border: 1px solid #ced4da;
        border-radius: 5px;
        padding: 10px;
        margin-top: 20px;
        background-color: #e9ecef;
    }

    .section-label {
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .newspaper-seats {
        display: flex;
        justify-content: space-around;
    }

    .newspaper-seat {
        width: 40px;
        height: 40px;
        border-radius: 5px;
    }

    /* Seat hover effect */
    .seat:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    /* List view for mobile */
    .seating-list-view {
        display: none;
    }

    .seating-list-view.active {
        display: block;
    }

    .reading-hall-layout.inactive {
        display: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .reading-hall-layout {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr auto;
        }

        .entrance-area, .librarian-desk {
            grid-column: 1;
        }

        .reading-tables {
            grid-column: 1;
            grid-row: 3;
        }

        .newspaper-section {
            grid-column: 1;
            grid-row: 4;
        }

        .table-row {
            flex-direction: column;
            gap: 20px;
        }

        .reading-table {
            width: 100%;
        }
    }
</style>
{% endblock %}
